version: '3.8'

# cc-obsidian-mem MCP Server
# Docker Compose with Traefik reverse proxy and Cloudflare Access OAuth 2.0
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. docker compose up -d
#
# Endpoints:
#   - https://obsidian-mem.example.com/.well-known/oauth-protected-resource - OAuth metadata (RFC 9728)
#   - https://obsidian-mem.example.com/mcp - Streamable HTTP
#   - https://obsidian-mem.example.com/sse - Legacy SSE
#   - https://obsidian-mem.example.com/health - Health check

services:
  obsidian-mem:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/z-m-huang/cc-obsidian-mem:latest
    container_name: obsidian-mem-mcp
    restart: unless-stopped

    environment:
      # Server Configuration
      - MCP_PORT=8080
      - MCP_HOST=0.0.0.0
      - TZ=${TZ:-America/New_York}

      # Vault Configuration
      - CC_OBSIDIAN_MEM_VAULT_PATH=/vault
      - CC_OBSIDIAN_MEM_FOLDER=${MEM_FOLDER:-_claude-mem}

      # OAuth/Authentication Configuration
      - AUTH_MODE=${AUTH_MODE:-bearer}
      - BEARER_TOKEN=${BEARER_TOKEN}
      - RESOURCE_URL=${RESOURCE_URL:-https://${DOMAIN}}

      # Cloudflare Access Configuration
      - CF_ACCESS_TEAM=${CF_ACCESS_TEAM}
      - CF_ACCESS_AUD=${CF_ACCESS_AUD}

      # CORS Configuration
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-https://claude.ai}

    volumes:
      # Mount your Obsidian vault (required)
      - ${VAULT_PATH:-./vault}:/vault

    expose:
      - "8080"

    networks:
      - traefik_proxy

    labels:
      # Traefik configuration
      - "traefik.enable=true"

      # HTTP Router
      - "traefik.http.routers.obsidian-mem.rule=Host(`${DOMAIN:-obsidian-mem.localhost}`)"
      - "traefik.http.routers.obsidian-mem.entrypoints=websecure"
      - "traefik.http.routers.obsidian-mem.tls=true"
      - "traefik.http.routers.obsidian-mem.tls.certresolver=${CERT_RESOLVER:-letsencrypt}"

      # Service configuration
      - "traefik.http.services.obsidian-mem.loadbalancer.server.port=8080"

      # CORS middleware (handles preflight and headers)
      - "traefik.http.middlewares.obsidian-mem-cors.headers.accesscontrolallowmethods=GET,POST,DELETE,OPTIONS"
      - "traefik.http.middlewares.obsidian-mem-cors.headers.accesscontrolallowheaders=Content-Type,Authorization,Mcp-Session-Id,CF-Access-JWT-Assertion"
      - "traefik.http.middlewares.obsidian-mem-cors.headers.accesscontrolexposeheaders=Mcp-Session-Id"
      - "traefik.http.middlewares.obsidian-mem-cors.headers.accesscontrolalloworiginlist=${ALLOWED_ORIGINS:-https://claude.ai}"
      - "traefik.http.middlewares.obsidian-mem-cors.headers.accesscontrolmaxage=86400"

      # Apply middleware
      - "traefik.http.routers.obsidian-mem.middlewares=obsidian-mem-cors"

      # Watchtower auto-update
      - "com.centurylinklabs.watchtower.enable=true"

      # Uptime Kuma monitoring labels
      - "kuma.obsidian-mem.http.name=Obsidian Memory MCP"
      - "kuma.obsidian-mem.http.url=https://${DOMAIN:-obsidian-mem.localhost}/health"
      - "kuma.obsidian-mem.http.interval=60"
      - "kuma.obsidian-mem.http.retryInterval=30"
      - "kuma.obsidian-mem.http.maxRetries=3"
      - "kuma.obsidian-mem.http.accepted_statuscodes=[\"200-299\"]"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Security options
    security_opt:
      - no-new-privileges:true

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

networks:
  traefik_proxy:
    external: true
